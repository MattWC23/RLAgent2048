from src.game import Game
from src.montecarlo import MCTS
import matplotlib.pyplot as plt
import csv
import concurrent.futures as cf
import os
os.chdir(os.path.dirname(__file__))
def hyper_param_trend(C):
    reward_bar = 0
    print(f'----- Starting C={C} --------')
    for i in range(5):
        print(f'Playing Game {i}')
        game = Game()
        reward_bar += play_game(game, C)
    print(f'----- completed C={C} -------')
    return reward_bar / 5



def play_game(game : Game, C):
    while not game.isTerminated():
        search_tree = MCTS(game, C)
        move = search_tree.next_move()
        game.move(move)
    
    return game.score

def process_parallel(Cs):
    with cf.ProcessPoolExecutor() as executor:
        ys = list(executor.map(hyper_param_trend, Cs))
        return ys

def main():
    # Cs = [0.5, 1.2, 5, 10, 25, 50, 75, 100, 200, 500]

    # ys = process_parallel(Cs)
    # print(f'Cs:{Cs}')
    # print(f'Ys:{ys}')
    Cs = []
    ys = []
    with open("output/hyperparam_results.csv", mode='r', newline="") as f:
        reader = csv.reader(f)
        header = next(reader)
        for row in reader:
            Cs.append(float(row[0]))
            ys.append(float(row[1]))
    plt.scatter(Cs, ys)
    plt.xlabel("C (UCT exploration constant)")
    plt.xscale('log')
    plt.ylabel("Average game score")
    plt.title("MCTS 2048 performance vs exploration constant")
    plt.show()


if __name__ == '__main__':
    main()